<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Äî PrePair</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- Main Styles -->
  <link rel="stylesheet" href="site.css">
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="app-layout">
  
  <!-- App Shell -->
  <div class="app-container">
    
    <!-- Left Sidebar -->
    <aside class="app-sidebar">
      <div class="sidebar-brand">
        <span class="wordmark">PrePair</span>
      </div>
      
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item active">
          <span>Dashboard</span>
        </a>
        <a href="opportunities.html" class="nav-item">
          <span>Opportunities</span>
        </a>
        <a href="applications.html" class="nav-item">
          <span>Applications</span>
        </a>
        <a href="edit-profile.html" class="nav-item">
          <span>Edit Profile</span>
        </a>
        <a href="help.html" class="nav-item">
          <span>Help</span>
        </a>
        <a href="settings.html" class="nav-item">
          <span>Settings</span>
        </a>
        <button type="button" class="nav-item nav-signout" id="signout-btn">
          <span>Sign Out</span>
        </button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="app-main">
      <div class="container">
        
        <!-- Hero Header with Gradient Background -->
        <section class="hero-section">
          <div class="hero-container">
            <div class="hero-content">
              <div class="hero-left">
                <div class="avatar avatar-lg" id="userAvatar">A</div>
                <div class="hero-text">
                  <h1 id="welcomeTitle" class="text-4xl font-bold text-primary">Welcome back, Alex!</h1>
                  <p class="text-lg text-secondary">Ready to explore new opportunities?</p>
                </div>
              </div>
              <div class="hero-right">
                <div class="profile-completion-card">
                  <div class="completion-header">
                    <span class="text-sm font-semibold text-primary">Profile Completion</span>
                    <span class="completion-percent text-coral font-bold" id="completionPercent">80%</span>
                  </div>
                  <div class="progress progress-large mb-2">
                    <div class="progress-bar" id="completionFill" style="width: 80%"></div>
                  </div>
                  <a href="edit-profile.html" class="text-sm text-coral font-medium">Complete your profile ‚Üí</a>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Navigation Tabs -->
        <section class="navigation-tabs">
          <div class="card">
            <div class="tab-container">
              <button type="button" class="nav-tab active" data-tab="browse">
                Browse opportunities
              </button>
              <button type="button" class="nav-tab" data-tab="application" id="newApplicationBtn">
                New application
              </button>
              <a href="edit-profile.html" class="nav-tab">
                Edit profile
              </a>
              <button type="button" class="nav-tab" data-tab="matches">
                View matches
              </button>
            </div>
          </div>
        </section>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
          
          <!-- Left Column: Main Feed -->
          <div class="dashboard-left">
            
            <!-- For You Opportunities -->
            <section class="opportunities-section" id="opportunities-section">
              <div class="section-header-standalone">
                <h2 class="text-3xl font-bold text-primary mb-2">Opportunities picked for you</h2>
                <p class="text-secondary">Curated internships that match your profile and interests</p>
              </div>
              
              <div class="opportunities-grid" id="opportunitiesGrid">
                <!-- Opportunities will be populated by JS -->
              </div>
            </section>

            <!-- Recent Applications -->
            <section class="recent-applications mt-8">
              <div class="card card-cream">
                <div class="card-padding">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-semibold text-primary">Recent applications</h3>
                    <a href="applications.html" class="text-coral font-medium">View all ‚Üí</a>
                  </div>
                  <div class="applications-list" id="recentApplicationsList">
                    <!-- Recent applications will be populated by JS -->
                  </div>
                </div>
              </div>
            </section>

            <!-- Announcements -->
            <section class="announcements mt-8">
              <div class="card card-lavender">
                <div class="card-padding">
                  <div class="flex items-center gap-3 mb-4">
                    <div class="announcement-icon">üì¢</div>
                    <h3 class="text-2xl font-semibold text-primary">Announcements</h3>
                  </div>
                  <div class="announcement-list">
                    <div class="announcement-item">
                      <div class="announcement-content">
                        <p class="text-primary font-medium">New internships in marketing and design this week</p>
                        <span class="text-xs text-muted">2 days ago</span>
                      </div>
                    </div>
                    <div class="announcement-item">
                      <div class="announcement-content">
                        <p class="text-primary font-medium">Career fair happening at Rose Hill campus next month</p>
                        <span class="text-xs text-muted">1 week ago</span>
                      </div>
                    </div>
                    <div class="announcement-item">
                      <div class="announcement-content">
                        <p class="text-primary font-medium">Updated application deadlines for spring programs</p>
                        <span class="text-xs text-muted">2 weeks ago</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>

          </div>

          <!-- Right Column: Quick Summary -->
          <div class="dashboard-right">
            
            <!-- Next Steps -->
            <section class="next-steps">
              <div class="card card-mint">
                <div class="card-padding">
                  <div class="flex items-center gap-3 mb-4">
                    <div class="checklist-icon">‚úÖ</div>
                    <h3 class="text-xl font-semibold text-primary">Next steps for you</h3>
                  </div>
                  <div class="next-steps-content" id="nextStepsContent">
                    <!-- Content populated by JS based on profile state -->
                    <div class="next-step-item">
                      <p class="text-sm text-secondary mb-3">Complete your profile to unlock better matches and stand out to employers.</p>
                      <a href="edit-profile.html" class="btn-primary btn-full">Complete Profile</a>
                    </div>
                    <div class="next-step-tips mt-4">
                      <div class="tip-item">
                        <span class="tip-bullet">‚Ä¢</span>
                        <span class="text-xs text-muted">Add your major and graduation year</span>
                      </div>
                      <div class="tip-item">
                        <span class="tip-bullet">‚Ä¢</span>
                        <span class="text-xs text-muted">Upload your resume</span>
                      </div>
                      <div class="tip-item">
                        <span class="tip-bullet">‚Ä¢</span>
                        <span class="text-xs text-muted">Set your campus preferences</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>

          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Opportunity Details Modal -->
  <div class="modal-overlay" id="opportunityModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Opportunity Details</h3>
        <button type="button" class="modal-close" id="modalCloseBtn">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content populated by JS -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn ghost" id="modalCloseFooter">Close</button>
        <button type="button" class="btn" id="modalApplyBtn">Apply now</button>
      </div>
    </div>
  </div>

  <!-- New Application Modal -->
  <div class="modal-overlay" id="newApplicationModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>New Application</h3>
        <button type="button" class="modal-close" id="newAppCloseBtn">&times;</button>
      </div>
      <form id="newApplicationForm">
        <div class="modal-body">
          <div class="form-group">
            <label for="newAppPosition">Position *</label>
            <input type="text" id="newAppPosition" name="position" required>
          </div>
          <div class="form-group">
            <label for="newAppCompany">Company *</label>
            <input type="text" id="newAppCompany" name="company" required>
          </div>
          <div class="form-group">
            <label for="newAppStatus">Status</label>
            <select id="newAppStatus" name="status">
              <option value="Applied">Applied</option>
              <option value="Interview">Interview</option>
              <option value="Offered">Offered</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn ghost" id="newAppCancelBtn">Cancel</button>
          <button type="submit" class="btn" id="newAppSubmitBtn">Add Application</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Toast -->
  <div class="toast" id="successToast" style="display: none;">
    <div class="toast-content">
      <span id="toastMessage">Success!</span>
    </div>
  </div>

  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://aezybthbsmpihbyzfiqi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlenlidGhic21waWhieXpmaXFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTUwNTUsImV4cCI6MjA3ODEzMTA1NX0.ojh8dzVpF62hqU_MrXI9EfCBJGX74NMse_1t55m32go';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global state
    let currentUser = null;
    let userProfile = null;
    let selectedOpportunity = null;

    // Demo opportunities data with company logos
    const recommendedOpportunities = [
      {
        id: 'marketing-1',
        title: 'Marketing Internship',
        company: 'Bronx Marketing Agency',
        companyLogo: null, // Will use initials fallback
        location: 'Hybrid ‚Ä¢ NYC',
        track: 'Marketing',
        category: 'MARKETING',
        summary: 'Plan and launch a mini campaign for a neighborhood brand.',
        description: 'Join our creative team to develop marketing strategies for local businesses. You\'ll work on social media campaigns, content creation, and event planning while gaining real-world experience in the marketing industry.',
        requirements: ['Marketing or Communications major preferred', 'Basic knowledge of social media platforms', 'Creative thinking and communication skills'],
        duration: '10-12 weeks, part-time during semester',
        cardColor: 'card-cream'
      },
      {
        id: 'tech-1',
        title: 'Software Development Intern',
        company: 'Tech Startup NYC',
        companyLogo: null, // Will use initials fallback
        location: 'Remote ‚Ä¢ NYC',
        track: 'Technology',
        category: 'TECHNOLOGY',
        summary: 'Build web applications using modern JavaScript frameworks.',
        description: 'Work alongside our development team to build and maintain web applications. You\'ll gain experience with React, Node.js, and cloud technologies while contributing to real products used by thousands of users.',
        requirements: ['Computer Science or related major', 'Experience with JavaScript and web development', 'Strong problem-solving skills'],
        duration: '12 weeks, full-time summer or part-time during semester',
        cardColor: 'card-lavender'
      },
      {
        id: 'design-1',
        title: 'UX Design Intern',
        company: 'Design Studio Brooklyn',
        companyLogo: null, // Will use initials fallback
        location: 'On-site ‚Ä¢ Brooklyn',
        track: 'Design',
        category: 'DESIGN',
        summary: 'Create user experiences for digital products and services.',
        description: 'Join our design team to research, prototype, and design user interfaces for web and mobile applications. You\'ll work on real client projects and learn the complete UX design process from research to final design.',
        requirements: ['Design, Psychology, or HCI major preferred', 'Basic knowledge of design tools (Figma, Sketch)', 'Portfolio of design work'],
        duration: '8-10 weeks, flexible schedule',
        cardColor: 'card-mint'
      },
      {
        id: 'operations-1',
        title: 'Operations & Data Intern',
        company: 'Financial Services Co.',
        companyLogo: null,
        location: 'On-site ‚Ä¢ Manhattan',
        track: 'Operations',
        category: 'OPERATIONS & DATA',
        summary: 'Analyze business processes and optimize operational workflows.',
        description: 'Support our operations team in data analysis, process improvement, and project management. You\'ll work with real business data and help implement solutions that impact company efficiency.',
        requirements: ['Business, Economics, or related major', 'Basic Excel and data analysis skills', 'Detail-oriented and analytical mindset'],
        duration: '10 weeks, full-time summer',
        cardColor: 'card-cream'
      },
      {
        id: 'marketing-2',
        title: 'Social Media Marketing Intern',
        company: 'Creative Agency Manhattan',
        companyLogo: null,
        location: 'Hybrid ‚Ä¢ NYC',
        track: 'Marketing',
        category: 'MARKETING',
        summary: 'Develop social media strategies for established brands.',
        description: 'Create engaging content, analyze social media metrics, and assist in campaign development for our diverse client portfolio including restaurants, retail, and tech companies.',
        requirements: ['Marketing, Communications, or related major', 'Strong social media presence', 'Creative writing and visual skills'],
        duration: '8-12 weeks, flexible',
        cardColor: 'card-lavender'
      },
      {
        id: 'tech-2',
        title: 'Product Management Intern',
        company: 'Fintech Startup',
        companyLogo: null,
        location: 'Remote ‚Ä¢ NYC',
        track: 'Technology',
        category: 'TECHNOLOGY',
        summary: 'Learn product strategy and user research methodologies.',
        description: 'Work with our product team to conduct user interviews, analyze product metrics, and assist in feature planning for our financial technology platform.',
        requirements: ['Business, Computer Science, or related major', 'Interest in technology and finance', 'Strong communication skills'],
        duration: '12 weeks, part-time',
        cardColor: 'card-mint'
      }
    ];

    // Authentication check
    async function requireAuth() {
      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        
        if (error || !user) {
          window.location.href = '/signin.html';
          return false;
        }
        
        currentUser = user;
        return true;
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/signin.html';
        return false;
      }
    }

    // Load user profile
    async function loadUserProfile() {
      try {
        const { data: profile, error } = await supabase
          .from('student_profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();

        if (error) {
          console.error('Error loading profile:', error);
          return null;
        }

        userProfile = profile;
        return profile;
      } catch (error) {
        console.error('Profile load failed:', error);
        return null;
      }
    }

    // Calculate profile completion
    function calculateProfileCompletion(profile) {
      if (!profile) return 0;
      
      const fields = ['name', 'surname', 'university', 'major', 'graduation_year', 'campus', 'nationality', 'birthday'];
      const filledFields = fields.filter(field => profile[field] && profile[field] !== '');
      
      return Math.round((filledFields.length / fields.length) * 100);
    }

    // Update hero section
    function updateHeroSection(profile) {
      const avatarEl = document.getElementById('userAvatar');
      const titleEl = document.getElementById('welcomeTitle');
      const percentEl = document.getElementById('completionPercent');
      const fillEl = document.getElementById('completionFill');

      // Avatar initials
      if (profile && profile.name) {
        const initials = (profile.name.charAt(0) + (profile.surname ? profile.surname.charAt(0) : '')).toUpperCase();
        avatarEl.textContent = initials;
      }

      // Welcome message
      if (profile && profile.name) {
        titleEl.textContent = `Welcome back, ${profile.name}!`;
      }

      // Profile completion
      const completion = calculateProfileCompletion(profile);
      percentEl.textContent = `${completion}% complete`;
      fillEl.style.width = `${completion}%`;
    }

    // Load recent applications
    async function loadRecentApplications() {
      try {
        const { data: applications, error } = await supabase
          .from('applications')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('applied_at', { ascending: false })
          .limit(5);

        if (error) {
          console.error('Error loading applications:', error);
          return [];
        }

        return applications || [];
      } catch (error) {
        console.error('Applications load failed:', error);
        return [];
      }
    }

    // Render recent applications
    function renderRecentApplications(applications) {
      const container = document.getElementById('recentApplicationsList');
      
      if (!applications || applications.length === 0) {
        container.innerHTML = `
          <div class="empty-applications">
            <div class="empty-icon text-4xl mb-3 text-center">üìã</div>
            <h4 class="text-lg font-semibold text-primary mb-2 text-center">Ready to take the first step?</h4>
            <p class="text-sm text-secondary mb-4 text-center">You haven't applied to any internships yet. Start by browsing our curated opportunities above.</p>
            <div class="text-center">
              <button type="button" class="btn-primary" onclick="scrollToOpportunities()">Browse opportunities</button>
            </div>
          </div>
        `;
        return;
      }

      container.innerHTML = applications.map(app => {
        const formattedDate = new Date(app.applied_at).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric'
        });

        const statusClass = {
          'Applied': 'badge-light',
          'Under Review': 'badge-warning', 
          'Interview': 'badge-info',
          'Accepted': 'badge-success',
          'Rejected': 'badge-error'
        }[app.status] || 'badge-light';

        return `
          <div class="recent-application-card flex items-center gap-3 p-3 border-b border-gray-100 last:border-b-0">
            <div class="app-logo">
              ${getCompanyLogo(app.company)}
            </div>
            <div class="app-details flex-1">
              <h5 class="text-base font-semibold text-primary">${app.position}</h5>
              <p class="text-sm text-secondary">${app.company}</p>
              <div class="app-meta flex items-center gap-2 mt-1">
                <span class="badge ${statusClass}">${app.status}</span>
                <span class="text-xs text-muted">${formattedDate}</span>
              </div>
            </div>
            <div class="app-actions">
              <a href="applications.html" class="text-coral text-sm font-medium">View ‚Üí</a>
            </div>
          </div>
        `;
      }).join('');
    }

    // Generate company logo or fallback
    function getCompanyLogo(company, logoUrl = null) {
      if (logoUrl) {
        return `<img src="${logoUrl}" alt="${company} logo" class="company-logo-img" />`;
      } else {
        // Create initials fallback
        const initials = company.split(' ')
          .map(word => word.charAt(0))
          .join('')
          .substring(0, 2)
          .toUpperCase();
        return `<div class="company-logo-fallback">${initials}</div>`;
      }
    }

    // Get category badge color
    function getCategoryBadgeClass(category) {
      const badgeClasses = {
        'MARKETING': 'category-marketing',
        'TECHNOLOGY': 'category-tech',
        'DESIGN': 'category-design',
        'OPERATIONS & DATA': 'category-operations'
      };
      return badgeClasses[category] || 'category-default';
    }

    // Render opportunities with new design system
    function renderOpportunities() {
      const container = document.getElementById('opportunitiesGrid');
      
      container.innerHTML = recommendedOpportunities.map(opp => `
        <div class="opportunity-card card ${opp.cardColor} card-hover" data-opportunity-id="${opp.id}">
          <div class="card-padding">
            <!-- For You Badge -->
            <div class="for-you-badge">
              <span class="badge badge-coral">For you</span>
            </div>
            
            <!-- Category Badge -->
            <div class="category-badge-container">
              <span class="category-badge ${getCategoryBadgeClass(opp.category)}">${opp.category}</span>
            </div>
            
            <!-- Company Logo Section -->
            <div class="company-logo-section">
              ${getCompanyLogo(opp.company, opp.companyLogo)}
            </div>
            
            <!-- Company Name -->
            <div class="company-name">
              <span class="text-sm font-medium text-secondary">${opp.company}</span>
            </div>
            
            <!-- Position Title -->
            <h4 class="opportunity-title text-xl font-semibold text-primary mb-2">${opp.title}</h4>
            
            <!-- Location -->
            <div class="location-info flex items-center gap-1 mb-3">
              <span class="location-icon">üìç</span>
              <span class="text-sm text-muted">${opp.location}</span>
            </div>
            
            <!-- Description -->
            <p class="opportunity-description text-sm text-secondary mb-4">${opp.summary}</p>
            
            <!-- Action Buttons -->
            <div class="opportunity-actions flex gap-2">
              <button type="button" class="btn-secondary flex-1 view-details-btn" data-opportunity-id="${opp.id}">
                View details
              </button>
              <button type="button" class="btn-primary flex-1 apply-btn" data-opportunity-id="${opp.id}">
                Apply
              </button>
            </div>
          </div>
        </div>
      `).join('');

      // Add event listeners
      document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', handleViewDetails);
      });

      document.querySelectorAll('.apply-btn').forEach(btn => {
        btn.addEventListener('click', handleQuickApply);
      });
    }

    // Update next steps
    function updateNextSteps(profile, applications) {
      const container = document.getElementById('nextStepsContent');
      const completion = calculateProfileCompletion(profile);

      let content = '';

      if (completion < 100) {
        content = `
          <div class="next-step-item">
            <div class="step-icon">üìù</div>
            <div class="step-content">
              <h4>Complete your profile</h4>
              <p class="muted">Add missing details to unlock better matches</p>
              <a href="edit-profile.html" class="btn ghost small">Edit profile</a>
            </div>
          </div>
        `;
      } else if (!applications || applications.length === 0) {
        content = `
          <div class="next-step-item">
            <div class="step-icon">üéØ</div>
            <div class="step-content">
              <h4>Apply to your first internship</h4>
              <p class="muted">Start with one of the recommended roles above</p>
              <button type="button" class="btn ghost small" onclick="scrollToOpportunities()">Browse opportunities</button>
            </div>
          </div>
        `;
      } else {
        const hasInterview = applications.some(app => app.status === 'Interview');
        const hasOffer = applications.some(app => app.status === 'Offered');

        if (hasOffer) {
          content = `
            <div class="next-step-item">
              <div class="step-icon">üéâ</div>
              <div class="step-content">
                <h4>You have offers!</h4>
                <p class="muted">Review your offers and make decisions</p>
                <a href="applications.html" class="btn ghost small">View applications</a>
              </div>
            </div>
          `;
        } else if (hasInterview) {
          content = `
            <div class="next-step-item">
              <div class="step-icon">üíº</div>
              <div class="step-content">
                <h4>Prepare for interviews</h4>
                <p class="muted">You have upcoming interview opportunities</p>
                <a href="applications.html" class="btn ghost small">View details</a>
              </div>
            </div>
          `;
        } else {
          content = `
            <div class="next-step-item">
              <div class="step-icon">üìà</div>
              <div class="step-content">
                <h4>Keep applying</h4>
                <p class="muted">Great progress! Consider applying to more roles</p>
                <button type="button" class="btn ghost small" onclick="scrollToOpportunities()">Browse opportunities</button>
              </div>
            </div>
          `;
        }
      }

      container.innerHTML = content;
    }

    // Scroll to opportunities
    function scrollToOpportunities() {
      document.getElementById('opportunities-section').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }

    // Handle view details
    function handleViewDetails(e) {
      const oppId = e.target.getAttribute('data-opportunity-id');
      selectedOpportunity = recommendedOpportunities.find(o => o.id === oppId);
      
      if (selectedOpportunity) {
        showOpportunityModal(selectedOpportunity);
      }
    }

    // Handle quick apply
    async function handleQuickApply(e) {
      const oppId = e.target.getAttribute('data-opportunity-id');
      const opportunity = recommendedOpportunities.find(o => o.id === oppId);
      
      if (opportunity) {
        await applyToOpportunity(opportunity);
      }
    }

    // Show opportunity modal
    function showOpportunityModal(opportunity) {
      const modal = document.getElementById('opportunityModal');
      const title = document.getElementById('modalTitle');
      const body = document.getElementById('modalBody');

      title.textContent = opportunity.title;
      
      body.innerHTML = `
        <div class="opportunity-details">
          <div class="detail-section">
            <h4>Company</h4>
            <p>${opportunity.company}</p>
          </div>
          <div class="detail-section">
            <h4>Location</h4>
            <p>${opportunity.location}</p>
          </div>
          <div class="detail-section">
            <h4>Description</h4>
            <p>${opportunity.description}</p>
          </div>
          <div class="detail-section">
            <h4>Requirements</h4>
            <ul>
              ${opportunity.requirements.map(req => `<li>${req}</li>`).join('')}
            </ul>
          </div>
          <div class="detail-section">
            <h4>Duration</h4>
            <p>${opportunity.duration}</p>
          </div>
        </div>
      `;

      modal.style.display = 'flex';
    }

    // Hide opportunity modal
    function hideOpportunityModal() {
      document.getElementById('opportunityModal').style.display = 'none';
      selectedOpportunity = null;
    }

    // Apply to opportunity
    async function applyToOpportunity(opportunity) {
      try {
        const { data, error } = await supabase
          .from('applications')
          .insert([
            {
              user_id: currentUser.id,
              position: opportunity.title,
              company: opportunity.company,
              status: 'Applied'
            }
          ]);

        if (error) {
          throw error;
        }

        // Refresh recent applications
        const applications = await loadRecentApplications();
        renderRecentApplications(applications);
        
        // Update next steps
        updateNextSteps(userProfile, applications);

        // Show success toast
        showToast(`Applied to ${opportunity.title} successfully!`);

        // Hide modal if open
        hideOpportunityModal();

      } catch (error) {
        console.error('Apply error:', error);
        showToast('Failed to submit application. Please try again.', 'error');
      }
    }

    // Show new application modal
    function showNewApplicationModal() {
      document.getElementById('newApplicationModal').style.display = 'flex';
      document.getElementById('newApplicationForm').reset();
    }

    // Hide new application modal
    function hideNewApplicationModal() {
      document.getElementById('newApplicationModal').style.display = 'none';
    }

    // Handle new application form
    async function handleNewApplicationSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const position = formData.get('position').trim();
      const company = formData.get('company').trim();
      const status = formData.get('status');

      if (!position || !company) {
        showToast('Please fill in all required fields.', 'error');
        return;
      }

      try {
        const submitBtn = document.getElementById('newAppSubmitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';

        const { data, error } = await supabase
          .from('applications')
          .insert([
            {
              user_id: currentUser.id,
              position,
              company,
              status
            }
          ]);

        if (error) {
          throw error;
        }

        // Refresh recent applications
        const applications = await loadRecentApplications();
        renderRecentApplications(applications);
        
        // Update next steps
        updateNextSteps(userProfile, applications);

        // Show success and hide modal
        showToast('Application added successfully!');
        hideNewApplicationModal();

      } catch (error) {
        console.error('Add application error:', error);
        showToast('Failed to add application. Please try again.', 'error');
      } finally {
        const submitBtn = document.getElementById('newAppSubmitBtn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Application';
      }
    }

    // Show toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('successToast');
      const messageEl = document.getElementById('toastMessage');
      
      messageEl.textContent = message;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';

      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    // Sign out
    async function handleSignOut() {
      try {
        await supabase.auth.signOut();
        window.location.href = '/';
      } catch (error) {
        console.error('Sign out error:', error);
      }
    }

    // Initialize dashboard
    async function initializeDashboard() {
      // Check authentication
      const isAuthenticated = await requireAuth();
      if (!isAuthenticated) return;

      // Load user profile
      const profile = await loadUserProfile();
      updateHeroSection(profile);

      // Load recent applications
      const applications = await loadRecentApplications();
      renderRecentApplications(applications);

      // Render opportunities
      renderOpportunities();

      // Update next steps
      updateNextSteps(profile, applications);
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      initializeDashboard();

      // Quick actions
      document.getElementById('browseOpportunitiesBtn').addEventListener('click', scrollToOpportunities);
      document.getElementById('newApplicationBtn').addEventListener('click', showNewApplicationModal);

      // Opportunity modal
      document.getElementById('modalCloseBtn').addEventListener('click', hideOpportunityModal);
      document.getElementById('modalCloseFooter').addEventListener('click', hideOpportunityModal);
      document.getElementById('modalApplyBtn').addEventListener('click', () => {
        if (selectedOpportunity) {
          applyToOpportunity(selectedOpportunity);
        }
      });

      // New application modal
      document.getElementById('newAppCloseBtn').addEventListener('click', hideNewApplicationModal);
      document.getElementById('newAppCancelBtn').addEventListener('click', hideNewApplicationModal);
      document.getElementById('newApplicationForm').addEventListener('submit', handleNewApplicationSubmit);

      // Sign out
      document.getElementById('signout-btn').addEventListener('click', handleSignOut);

      // Close modals when clicking overlay
      document.getElementById('opportunityModal').addEventListener('click', (e) => {
        if (e.target.id === 'opportunityModal') {
          hideOpportunityModal();
        }
      });

      document.getElementById('newApplicationModal').addEventListener('click', (e) => {
        if (e.target.id === 'newApplicationModal') {
          hideNewApplicationModal();
        }
      });
    });
  </script>

  <style>
    /* Dashboard Layout Tweaks */
    .app-layout {
      background-color: var(--bg, #fefefe);
    }

    .app-container {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
    }

    .app-sidebar {
      background: var(--card, white);
      border-right: 1px solid var(--border, #e5e5e5);
      padding: 32px 0;
      overflow-y: auto;
    }

    .sidebar-brand {
      padding: 0 32px 32px;
      border-bottom: 1px solid var(--border, #e5e5e5);
    }

    .sidebar-brand .wordmark {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text, #1a1a1a);
    }

    .sidebar-nav {
      padding-top: 32px;
      display: flex;
      flex-direction: column;
    }

    .nav-item {
      display: block;
      padding: 12px 32px;
      color: var(--text, #1a1a1a);
      text-decoration: none;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      transition: all 0.15s ease;
      margin: 2px 0;
    }

    .nav-item:hover {
      background-color: var(--sage, #f0f4f0);
      transform: translateY(-1px);
    }

    .nav-item.active {
      background-color: var(--sage, #f0f4f0);
      font-weight: 600;
    }

    .nav-signout {
      margin-top: auto;
      color: var(--muted, #666);
    }

    .app-main {
      padding: 40px;
      overflow-y: auto;
    }

    /* Hero Header */
    .hero-header {
      margin-bottom: 32px;
    }

    .hero-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 40px;
      border: 2px solid var(--border, #e5e5e5);
    }

    .hero-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .user-avatar {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--text, #1a1a1a), var(--muted, #666));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .hero-text h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.75rem;
      margin-bottom: 4px;
    }

    .profile-completion {
      text-align: right;
    }

    .completion-text {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .completion-label {
      color: var(--muted, #666);
    }

    .completion-percent {
      font-weight: 600;
    }

    .completion-bar {
      width: 120px;
      height: 6px;
      background: var(--border, #e5e5e5);
      border-radius: 3px;
      overflow: hidden;
    }

    .completion-fill {
      height: 100%;
      background: var(--sage, #90c695);
      transition: width 0.3s ease;
    }

    /* Quick Actions */
    .quick-actions {
      margin-bottom: 40px;
    }

    .action-buttons {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 32px;
      align-items: start;
    }

    .dashboard-left > section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .view-all-link {
      color: var(--text, #1a1a1a);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: opacity 0.15s ease;
    }

    .view-all-link:hover {
      opacity: 0.7;
    }

    /* Opportunities Grid */
    .opportunities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }

    .opportunity-card {
      border: 1px solid var(--border, #e5e5e5);
      border-radius: 12px;
      padding: 24px;
      transition: all 0.15s ease;
      background: white;
    }

    .opportunity-card:hover {
      border-color: var(--sage, #90c695);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .opp-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .opp-track {
      font-size: 0.8rem;
      color: var(--muted, #666);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .opp-badge {
      background: var(--sage, #90c695);
      color: var(--text, #1a1a1a);
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .opp-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .opp-company {
      margin-bottom: 12px;
      font-size: 0.9rem;
    }

    .opp-summary {
      margin-bottom: 20px;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .opp-actions {
      display: flex;
      gap: 12px;
    }

    .btn.small {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    /* Applications List */
    .applications-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .application-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--border, #e5e5e5);
    }

    .application-item:last-child {
      border-bottom: none;
    }

    .app-position {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 1rem;
    }

    .app-company {
      font-size: 0.9rem;
    }

    .app-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .status-applied {
      background: var(--sage, #90c695);
      color: var(--text, #1a1a1a);
    }

    .status-interview {
      background: #e3f2fd;
      color: #1976d2;
    }

    .status-offered {
      background: #e8f5e8;
      color: #2e7d32;
    }

    .status-rejected {
      background: #ffebee;
      color: #d32f2f;
    }

    .app-date {
      font-size: 0.8rem;
    }

    /* Next Steps */
    .next-steps-content {
      padding: 8px 0;
    }

    .next-step-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .step-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
      margin-top: 4px;
    }

    .step-content h4 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .step-content p {
      margin-bottom: 12px;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    /* Announcements */
    .announcement-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .announcement-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .announcement-bullet {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--sage, #90c695);
      margin-top: 8px;
      flex-shrink: 0;
    }

    .announcement-item p {
      margin: 0;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 32px 16px;
    }

    .empty-state p {
      margin-bottom: 16px;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 24px 0;
    }

    .modal-header h3 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--muted, #666);
      padding: 4px;
      line-height: 1;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 0 24px 24px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .detail-section {
      margin-bottom: 24px;
    }

    .detail-section:last-child {
      margin-bottom: 0;
    }

    .detail-section h4 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .detail-section ul {
      margin: 0;
      padding-left: 20px;
    }

    .detail-section li {
      margin-bottom: 4px;
    }

    /* Form Groups */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border, #e5e5e5);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.15s ease;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--text, #1a1a1a);
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      padding: 16px 24px;
      border-radius: 8px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .toast.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .toast.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 24px;
      }

      .opportunities-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .app-container {
        grid-template-columns: 1fr;
      }

      .app-sidebar {
        border-right: none;
        border-bottom: 1px solid var(--border, #e5e5e5);
        padding: 16px 0;
      }

      .sidebar-brand {
        padding: 0 16px 16px;
      }

      .sidebar-nav {
        padding-top: 16px;
        flex-direction: row;
        overflow-x: auto;
        gap: 0;
      }

      .nav-item {
        padding: 12px 16px;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .app-main {
        padding: 20px;
      }

      .hero-card {
        flex-direction: column;
        align-items: stretch;
        gap: 24px;
        text-align: center;
      }

      .hero-left {
        flex-direction: column;
        text-align: center;
      }

      .profile-completion {
        text-align: center;
      }

      .completion-bar {
        margin: 0 auto;
      }

      .action-buttons {
        flex-direction: column;
      }

      .application-item {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      .app-meta {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      .opp-actions {
        flex-direction: column;
      }

      .modal-content {
        margin: 20px;
      }
    }

    /* ===== NEW DASHBOARD DESIGN SYSTEM ===== */

    /* Hero Section */
    .hero-section {
      background: var(--bg-gradient-hero);
      padding: var(--space-6) 0;
      margin: 0 calc(-1 * var(--space-3));
      border-radius: 0 0 var(--radius-2xl) var(--radius-2xl);
    }

    .hero-container {
      max-width: var(--container-dashboard);
      margin: 0 auto;
      padding: 0 var(--space-3);
    }

    .hero-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-6);
    }

    .hero-left {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .hero-text h1 {
      margin: 0 0 var(--space-1) 0;
      line-height: var(--leading-tight);
    }

    .hero-text p {
      margin: 0;
      line-height: var(--leading-normal);
    }

    .profile-completion-card {
      background: var(--bg-card);
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      min-width: 260px;
    }

    .completion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
    }

    /* Navigation Tabs */
    .navigation-tabs {
      margin: var(--space-6) 0;
    }

    .tab-container {
      display: flex;
      gap: var(--space-2);
      padding: var(--space-2);
    }

    .nav-tab {
      flex: 1;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-full);
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-weight: var(--font-medium);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast) ease;
      text-decoration: none;
      text-align: center;
      white-space: nowrap;
    }

    .nav-tab:hover {
      background: var(--bg-cream);
      color: var(--text-primary);
    }

    .nav-tab.active {
      background: var(--coral);
      color: var(--text-white);
    }

    /* Section Headers */
    .section-header-standalone {
      margin-bottom: var(--space-6);
    }

    /* Opportunities Grid */
    .opportunities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-8);
    }

    /* Opportunity Cards */
    .opportunity-card {
      position: relative;
      min-height: 400px;
      cursor: pointer;
    }

    .for-you-badge {
      position: absolute;
      top: var(--space-2);
      right: var(--space-2);
      z-index: 10;
    }

    .category-badge-container {
      margin-bottom: var(--space-3);
    }

    .category-badge {
      padding: 4px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .category-marketing {
      background: var(--coral-light);
      color: var(--coral-hover);
    }

    .category-tech {
      background: #E3F2FD;
      color: #1976D2;
    }

    .category-design {
      background: var(--bg-lavender);
      color: #673AB7;
    }

    .category-operations {
      background: var(--bg-mint);
      color: #2E7D32;
    }

    /* Company Logo Section */
    .company-logo-section {
      display: flex;
      justify-content: center;
      margin-bottom: var(--space-3);
    }

    .company-logo-img {
      max-width: 120px;
      max-height: 80px;
      object-fit: contain;
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      padding: var(--space-2);
    }

    .company-logo-fallback {
      width: 120px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--coral);
      color: var(--text-white);
      border-radius: var(--radius-md);
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      letter-spacing: 0.05em;
    }

    .company-name {
      text-align: center;
      margin-bottom: var(--space-2);
    }

    .opportunity-title {
      text-align: center;
      line-height: var(--leading-tight);
    }

    .location-info {
      justify-content: center;
    }

    .location-icon {
      font-size: var(--text-sm);
    }

    .opportunity-description {
      line-height: var(--leading-relaxed);
      text-align: center;
    }

    .opportunity-actions {
      margin-top: auto;
    }

    /* Recent Applications */
    .recent-application-card {
      padding: var(--space-3);
      border-bottom: 1px solid var(--border-light);
    }

    .recent-application-card:last-child {
      border-bottom: none;
    }

    .app-logo .company-logo-fallback {
      width: 48px;
      height: 48px;
      font-size: var(--text-lg);
      border-radius: var(--radius-md);
    }

    .app-logo .company-logo-img {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      padding: 4px;
    }

    /* Empty Applications */
    .empty-applications {
      padding: var(--space-8) var(--space-3);
      text-align: center;
    }

    /* Announcement Updates */
    .announcement-icon {
      font-size: var(--text-2xl);
    }

    .announcement-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .announcement-item {
      padding: var(--space-3);
      border-left: 3px solid var(--coral);
      background: rgba(255, 139, 123, 0.05);
      border-radius: 0 var(--radius-md) var(--radius-md) 0;
    }

    .announcement-content p {
      margin: 0 0 var(--space-1) 0;
      line-height: var(--leading-normal);
    }

    /* Next Steps Updates */
    .checklist-icon, .tip-bullet {
      color: var(--coral);
    }

    .next-step-tips {
      border-top: 1px solid var(--border-light);
      padding-top: var(--space-3);
    }

    .tip-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-2);
      margin-bottom: var(--space-1);
    }

    .tip-bullet {
      font-weight: var(--font-bold);
      margin-top: 2px;
    }

    /* Dashboard Grid Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: var(--space-6);
    }

    /* Mobile Responsiveness */
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: var(--space-4);
      }
      
      .hero-content {
        flex-direction: column;
        text-align: center;
        gap: var(--space-4);
      }
      
      .profile-completion-card {
        min-width: auto;
        width: 100%;
        max-width: 400px;
      }
      
      .opportunities-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--space-3);
      }
    }

    @media (max-width: 768px) {
      .hero-section {
        padding: var(--space-4) 0;
        margin: 0 calc(-1 * var(--space-2));
        border-radius: 0 0 var(--radius-xl) var(--radius-xl);
      }
      
      .hero-container {
        padding: 0 var(--space-2);
      }
      
      .hero-left {
        flex-direction: column;
        gap: var(--space-2);
      }
      
      .tab-container {
        flex-wrap: wrap;
        gap: var(--space-1);
      }
      
      .nav-tab {
        flex: none;
        min-width: calc(50% - var(--space-1)/2);
      }
      
      .opportunities-grid {
        grid-template-columns: 1fr;
        gap: var(--space-3);
      }
      
      .opportunity-card {
        min-height: auto;
      }
      
      .recent-application-card {
        padding: var(--space-2);
      }
    }

    /* Additional Badge Colors */
    .badge-info {
      background: var(--info);
      color: var(--text-white);
    }

    /* Flex Utilities */
    .flex-1 {
      flex: 1;
    }
  </style>

</body>
</html>