<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apply to Opportunity ‚Äî PrePair</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>
  <script src="js/supabase-client.js"></script>
  
  <!-- Main Styles -->
  <link rel="stylesheet" href="shared.css">

  <style>

    /* Custom styles for multi-step application flow */
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    /* Main Container */
    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: var(--space-6);
      min-height: calc(100vh - 80px);
    }

    .breadcrumb {
      margin-bottom: var(--space-4);
      color: var(--text-secondary);
    }

    .breadcrumb a {
      color: var(--coral);
      text-decoration: none;
      font-weight: var(--font-medium);
      transition: all var(--transition-fast) ease;
    }

    .breadcrumb a:hover {
      color: var(--coral-hover);
    }

    /* Multi-Step Progress Bar */
    .progress-container {
      background: var(--bg-card);
      padding: var(--space-4) var(--space-6);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow-md);
    }

    .progress-header {
      text-align: center;
      margin-bottom: var(--space-6);
    }

    .progress-title {
      font-family: var(--font-heading);
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      margin-bottom: var(--space-2);
    }

    .progress-subtitle {
      color: var(--text-secondary);
      font-size: var(--text-lg);
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .progress-line {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--border-light);
      z-index: 1;
      transform: translateY(-50%);
    }

    .progress-line-fill {
      height: 100%;
      background: var(--coral);
      transition: width var(--transition-slow) ease;
      border-radius: var(--radius-full);
    }

    .progress-step {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: var(--bg-card);
      padding: var(--space-1);
    }

    .step-circle {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: var(--font-bold);
      margin-bottom: var(--space-2);
      transition: all var(--transition-normal) ease;
    }

    .step-circle.pending {
      background: var(--bg-cream);
      color: var(--text-muted);
      border: 2px solid var(--border-light);
    }

    .step-circle.active {
      background: var(--coral);
      color: var(--text-white);
      border: 2px solid var(--coral);
      box-shadow: 0 0 0 4px var(--coral-light);
    }

    .step-circle.completed {
      background: var(--success);
      color: var(--text-white);
      border: 2px solid var(--success);
    }

    .step-label {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      text-align: center;
      color: var(--text-secondary);
      max-width: 100px;
    }

    .step-label.active {
      color: var(--text-primary);
      font-weight: var(--font-semibold);
    }

    /* Step Content Container */
    .step-content {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      box-shadow: var(--shadow-md);
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .step-header {
      text-align: center;
      margin-bottom: var(--space-6);
    }

    .step-title {
      font-family: var(--font-heading);
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      margin-bottom: var(--space-2);
    }

    .step-description {
      color: var(--text-secondary);
      font-size: var(--text-lg);
      line-height: var(--leading-relaxed);
    }

    /* Opportunity Header */
    .opportunity-preview {
      background: var(--bg-gradient-hero);
      padding: var(--space-6);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-6);
      text-align: center;
    }

    .opportunity-logo {
      display: flex;
      justify-content: center;
      margin-bottom: var(--space-3);
    }

    .company-logo-fallback {
      width: 80px;
      height: 60px;
      background: var(--coral);
      color: var(--text-white);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
    }

    .opportunity-title {
      font-family: var(--font-heading);
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      margin-bottom: var(--space-1);
    }

    .opportunity-company {
      color: var(--coral);
      font-weight: var(--font-semibold);
      font-size: var(--text-lg);
    }

    /* Form Styling */
    .step-form {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .form-content {
      flex: 1;
    }

    .form-section {
      margin-bottom: var(--space-6);
    }

    .section-title {
      font-family: var(--font-heading);
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      margin-bottom: var(--space-3);
      color: var(--text-primary);
    }

    .form-grid {
      display: grid;
      gap: var(--space-4);
    }

    .form-grid-2 {
      grid-template-columns: 1fr 1fr;
    }

    .input-group {
      margin-bottom: var(--space-3);
    }

    .input-label {
      display: block;
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--text-primary);
      margin-bottom: var(--space-1);
    }

    .required {
      color: var(--error);
    }

    .input-field, .textarea-field, .file-input {
      width: 100%;
      padding: var(--space-3);
      border: 2px solid var(--border-light);
      border-radius: var(--radius-lg);
      font-family: var(--font-primary);
      font-size: var(--text-base);
      background: var(--bg-card);
      transition: all var(--transition-fast) ease;
      box-sizing: border-box;
    }

    .input-field:focus, .textarea-field:focus, .file-input:focus {
      outline: none;
      border-color: var(--coral);
      box-shadow: 0 0 0 3px var(--coral-light);
    }

    .textarea-field {
      min-height: 120px;
      resize: vertical;
    }

    .input-help {
      font-size: var(--text-sm);
      color: var(--text-muted);
      margin-top: var(--space-1);
    }

    .error-message {
      color: var(--error);
      font-size: var(--text-sm);
      margin-top: var(--space-1);
    }

    /* File Upload States */
    .file-upload-area {
      border: 2px dashed var(--border-medium);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      text-align: center;
      background: var(--bg-cream);
      transition: all var(--transition-normal) ease;
      cursor: pointer;
    }

    .file-upload-area:hover {
      border-color: var(--coral);
      background: var(--coral-light);
    }

    .file-upload-icon {
      font-size: var(--text-4xl);
      color: var(--text-muted);
      margin-bottom: var(--space-2);
    }

    .file-upload-text {
      color: var(--text-secondary);
      font-size: var(--text-base);
      margin-bottom: var(--space-1);
    }

    .file-upload-help {
      color: var(--text-muted);
      font-size: var(--text-sm);
    }

    .file-uploading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      color: var(--coral);
      font-size: var(--text-sm);
      padding: var(--space-2);
    }

    .upload-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-light);
      border-top: 2px solid var(--coral);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .file-uploaded {
      color: var(--success);
      font-size: var(--text-sm);
      text-align: center;
      padding: var(--space-2);
    }

    .upload-success {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-1);
    }

    /* Step Navigation */
    .step-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-3);
      margin-top: var(--space-6);
      padding-top: var(--space-6);
      border-top: 1px solid var(--border-light);
    }

    .nav-buttons {
      display: flex;
      gap: var(--space-3);
    }

    .btn-step {
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-lg);
      font-weight: var(--font-semibold);
      font-size: var(--text-base);
      cursor: pointer;
      transition: all var(--transition-normal) ease;
      border: none;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      min-width: 120px;
      justify-content: center;
    }

    .btn-previous {
      background: var(--bg-cream);
      color: var(--text-secondary);
      border: 2px solid var(--border-light);
    }

    .btn-previous:hover {
      background: var(--bg-lavender);
      color: var(--text-primary);
    }

    .btn-next {
      background: var(--coral);
      color: var(--text-white);
    }

    .btn-next:hover {
      background: var(--coral-hover);
      transform: translateY(-1px);
    }

    .btn-next:disabled {
      background: var(--bg-cream);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }

    .btn-submit {
      background: var(--success);
      color: var(--text-white);
    }

    .btn-submit:hover {
      background: #4CAF50;
      transform: translateY(-1px);
    }

    /* Loading and Error States */
    .loading, .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-8);
      color: var(--text-secondary);
      text-align: center;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
    }

    .loading-spinner {
      margin-bottom: var(--space-2);
    }

    /* Review Step Styling */
    .review-section {
      background: var(--bg-cream);
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-4);
    }

    .review-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--space-3) 0;
      border-bottom: 1px solid var(--border-light);
    }

    .review-item:last-child {
      border-bottom: none;
    }

    .review-label {
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      flex: 1;
    }

    .review-value {
      color: var(--text-secondary);
      flex: 2;
      text-align: right;
    }

    .edit-button {
      background: none;
      border: none;
      color: var(--coral);
      font-size: var(--text-sm);
      cursor: pointer;
      padding: var(--space-1);
      margin-left: var(--space-2);
      text-decoration: underline;
    }

    .edit-button:hover {
      color: var(--coral-hover);
    }

    /* Success State */
    .success-state {
      background: var(--bg-card);
      border: 2px solid var(--success);
      border-radius: var(--radius-lg);
      padding: var(--space-8);
      box-shadow: var(--shadow-lg);
      text-align: center;
    }

    .success-icon {
      font-size: var(--text-6xl);
      color: var(--success);
      margin-bottom: var(--space-4);
    }

    .success-title {
      font-family: var(--font-heading);
      font-size: var(--text-4xl);
      font-weight: var(--font-bold);
      margin-bottom: var(--space-3);
      color: var(--success);
    }

    .success-description {
      color: var(--text-secondary);
      font-size: var(--text-lg);
      line-height: var(--leading-relaxed);
      margin-bottom: var(--space-6);
    }

    .actions-row {
      display: flex;
      gap: var(--space-3);
      justify-content: center;
      margin-top: var(--space-6);
    }

    /* Toast Messages */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      color: white;
      font-weight: 500;
      box-shadow: var(--shadow);
      transform: translateX(400px);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 350px;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success { background: var(--success); }
    .toast.error { background: var(--error); }
    .toast.info { background: var(--accent); }

    .toast-content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .toast-icon {
      font-size: 1.125rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-container {
        padding: var(--space-3);
      }

      .progress-container {
        padding: var(--space-3);
      }

      .progress-steps {
        flex-wrap: wrap;
        gap: var(--space-2);
      }

      .step-content {
        padding: var(--space-4);
      }

      .form-grid-2 {
        grid-template-columns: 1fr;
      }

      .step-navigation {
        flex-direction: column;
        align-items: stretch;
      }

      .nav-buttons {
        flex-direction: column;
      }

      .btn-step {
        width: 100%;
      }

      .actions-row {
        flex-direction: column;
        align-items: stretch;
      }

      .step-circle {
        width: 40px;
        height: 40px;
      }

      .step-label {
        font-size: var(--text-xs);
      }
    }
  </style>
</head>
<body>
  <div id="nav-container"></div>

  <main class="main-container">
    <nav class="breadcrumb">
      <a href="/opportunities.html">‚Üê Back to Opportunities</a>
    </nav>

    <div id="applicationContainer" class="loading">
      <div class="loading-spinner"></div>
      Loading application form...
    </div>
  </main>

  <script src="shared.js"></script>
  <script>
    const supabase = window.sb;

    // Get opportunity ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const opportunityId = urlParams.get('id');

    // Multi-step application state
    let currentStep = 1;
    const totalSteps = 4;
    let currentOpportunity = null;
    let applicationData = {
      personalInfo: {},
      questions: {},
      files: {},
      review: {}
    };

    // Step configuration
    const steps = [
      { id: 1, label: 'Personal Info', icon: 'üë§' },
      { id: 2, label: 'Questions', icon: 'üìù' },
      { id: 3, label: 'Documents', icon: 'üìÑ' },
      { id: 4, label: 'Review', icon: '‚úì' }
    ];

    // Initialize page
    async function initApplicationPage() {
      try {
        // OAuth hash cleanup
        if (location.hash.includes('access_token')) {
          history.replaceState(null, '', location.pathname);
        }

        const user = await requireAuth();
        if (!user) return;

        if (!opportunityId) {
          showError('No opportunity ID provided');
          return;
        }

        await loadOpportunityAndForm();

      } catch (error) {
        console.error('[apply-opportunity/init]', { error });
        showError('Failed to load application form. Please try again.');
      }
    }

    // Generate company logo or fallback
    function getCompanyLogo(company, logoUrl = null) {
      if (logoUrl) {
        return `<img src="${logoUrl}" alt="${company} logo" class="company-logo-img" />`;
      } else {
        const initials = company.split(' ')
          .map(word => word.charAt(0))
          .join('')
          .substring(0, 2)
          .toUpperCase();
        return `<div class="company-logo-fallback">${initials}</div>`;
      }
    }

    // Load opportunity and check for existing application
    async function loadOpportunityAndForm() {
      try {
        const { data: opportunity, error: oppError } = await supabase
          .from('opportunities')
          .select('*')
          .eq('id', opportunityId)
          .single();

        if (oppError) {
          console.error('[opportunities/select]', { error: oppError, opportunityId });
          throw oppError;
        }

        if (!opportunity) {
          showError('Opportunity not found');
          return;
        }

        // Check for existing application
        const session = await getSession();
        const user = session?.user;

        if (!user) {
          showError('Please sign in to continue.');
          return;
        }

        const { data: existingApplication } = await supabase
          .from('applications')
          .select('id')
          .eq('opportunity_id', opportunityId)
          .eq('user_id', user?.id || '')
          .limit(1);

        if (existingApplication && existingApplication.length > 0) {
          showAlreadyApplied(opportunity);
          return;
        }

        currentOpportunity = opportunity;
        renderMultiStepForm(opportunity);

      } catch (error) {
        console.error('[apply-opportunity/load]', { error });
        document.getElementById('applicationContainer').innerHTML = `
          <div class="error-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <h3 style="color: var(--error);">Failed to load application form</h3>
            <p>Please try refreshing the page.</p>
            <div class="mt-4">
              <button class="btn-primary" onclick="window.location.reload()">
                Try Again
              </button>
            </div>
          </div>
        `;
      }
    }

    // Render multi-step application form
    function renderMultiStepForm(opportunity) {
      const container = document.getElementById('applicationContainer');
      
      container.innerHTML = `
        <!-- Progress Header -->
        <div class="progress-container">
          <div class="progress-header">
            <h1 class="progress-title">Apply to ${opportunity.title}</h1>
            <p class="progress-subtitle">Complete your application in ${totalSteps} simple steps</p>
          </div>
          
          <!-- Progress Steps -->
          <div class="progress-steps">
            <div class="progress-line">
              <div class="progress-line-fill" id="progressFill"></div>
            </div>
            ${steps.map(step => `
              <div class="progress-step">
                <div class="step-circle ${getStepStatus(step.id)}" id="step${step.id}Circle">
                  ${step.id <= currentStep ? (step.id < currentStep ? '‚úì' : step.icon) : step.id}
                </div>
                <div class="step-label ${step.id === currentStep ? 'active' : ''}">${step.label}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Opportunity Preview -->
        <div class="opportunity-preview">
          <div class="opportunity-logo">
            ${getCompanyLogo(opportunity.company, opportunity.company_logo)}
          </div>
          <h2 class="opportunity-title">${opportunity.title}</h2>
          <p class="opportunity-company">${opportunity.company}</p>
        </div>

        <!-- Step Content -->
        <div class="step-content" id="stepContent">
          ${renderStepContent(currentStep)}
        </div>
      `;

      updateProgressBar();
      setupStepEventListeners();
    }

    // Get step status for styling
    function getStepStatus(stepId) {
      if (stepId < currentStep) return 'completed';
      if (stepId === currentStep) return 'active';
      return 'pending';
    }

    // Render step content based on current step
    function renderStepContent(step) {
      switch (step) {
        case 1:
          return renderPersonalInfoStep();
        case 2:
          return renderQuestionsStep();
        case 3:
          return renderDocumentsStep();
        case 4:
          return renderReviewStep();
        default:
          return '';
      }
    }

    // Step 1: Personal Info
    function renderPersonalInfoStep() {
      return `
        <form class="step-form" id="personalInfoForm">
          <div class="step-header">
            <h2 class="step-title">Personal Information</h2>
            <p class="step-description">Tell us about yourself to personalize your application.</p>
          </div>
          
          <div class="form-content">
            <div class="form-grid form-grid-2">
              <div class="input-group">
                <label class="input-label">First Name <span class="required">*</span></label>
                <input type="text" class="input-field" name="firstName" id="firstName" required>
              </div>
              <div class="input-group">
                <label class="input-label">Last Name <span class="required">*</span></label>
                <input type="text" class="input-field" name="lastName" id="lastName" required>
              </div>
            </div>
            
            <div class="input-group">
              <label class="input-label">Email Address <span class="required">*</span></label>
              <input type="email" class="input-field" name="email" id="email" required>
              <span class="input-help">We'll use this to contact you about your application</span>
            </div>
            
            <div class="input-group">
              <label class="input-label">Phone Number</label>
              <input type="tel" class="input-field" name="phone" id="phone">
            </div>
            
            <div class="form-grid form-grid-2">
              <div class="input-group">
                <label class="input-label">University/College <span class="required">*</span></label>
                <input type="text" class="input-field" name="university" id="university" required>
              </div>
              <div class="input-group">
                <label class="input-label">Major/Field of Study <span class="required">*</span></label>
                <input type="text" class="input-field" name="major" id="major" required>
              </div>
            </div>
            
            <div class="form-grid form-grid-2">
              <div class="input-group">
                <label class="input-label">Graduation Year <span class="required">*</span></label>
                <select class="input-field" name="graduationYear" id="graduationYear" required>
                  <option value="">Select year</option>
                  ${generateYearOptions()}
                </select>
              </div>
              <div class="input-group">
                <label class="input-label">GPA (Optional)</label>
                <input type="text" class="input-field" name="gpa" id="gpa" placeholder="e.g., 3.5">
              </div>
            </div>
          </div>
          
          <div class="step-navigation">
            <div></div>
            <div class="nav-buttons">
              <button type="submit" class="btn-step btn-next">
                Next Step <span>‚Üí</span>
              </button>
            </div>
          </div>
        </form>
      `;
    }

    // Step 2: Questions
    function renderQuestionsStep() {
      const questions = currentOpportunity.questions || [];
      
      return `
        <form class="step-form" id="questionsForm">
          <div class="step-header">
            <h2 class="step-title">Application Questions</h2>
            <p class="step-description">${questions.length > 0 ? 'Answer these questions to help us understand your fit for this role.' : 'No additional questions for this opportunity.'}</p>
          </div>
          
          <div class="form-content">
            ${questions.length > 0 ? questions.map((q, index) => renderQuestion(q, index)).join('') : 
              '<div class="text-center p-8"><p class="text-secondary">Great news! No additional questions needed for this opportunity.</p></div>'}
          </div>
          
          <div class="step-navigation">
            <div class="nav-buttons">
              <button type="button" class="btn-step btn-previous" onclick="goToStep(1)">
                <span>‚Üê</span> Previous
              </button>
            </div>
            <div class="nav-buttons">
              <button type="submit" class="btn-step btn-next">
                Next Step <span>‚Üí</span>
              </button>
            </div>
          </div>
        </form>
      `;
    }

    // Step 3: Documents
    function renderDocumentsStep() {
      const hasFileQuestions = currentOpportunity.questions?.some(q => q.type === 'file') || false;
      
      return `
        <form class="step-form" id="documentsForm">
          <div class="step-header">
            <h2 class="step-title">Upload Documents</h2>
            <p class="step-description">${hasFileQuestions ? 'Upload the required documents for your application.' : 'Upload your resume and any supporting documents.'}</p>
          </div>
          
          <div class="form-content">
            <!-- Standard Resume Upload -->
            <div class="input-group">
              <label class="input-label">Resume/CV <span class="required">*</span></label>
              <div class="file-upload-area" onclick="document.getElementById('resumeFile').click()">
                <div class="file-upload-icon">üìÑ</div>
                <div class="file-upload-text">Click to upload your resume</div>
                <div class="file-upload-help">PDF, DOC, DOCX (max 10MB)</div>
                <input type="file" id="resumeFile" accept=".pdf,.doc,.docx" style="display: none;">
              </div>
              <div id="resumeStatus" class="mt-2"></div>
            </div>
            
            <!-- Cover Letter (Optional) -->
            <div class="input-group">
              <label class="input-label">Cover Letter (Optional)</label>
              <div class="file-upload-area" onclick="document.getElementById('coverLetterFile').click()">
                <div class="file-upload-icon">üìù</div>
                <div class="file-upload-text">Click to upload your cover letter</div>
                <div class="file-upload-help">PDF, DOC, DOCX (max 10MB)</div>
                <input type="file" id="coverLetterFile" accept=".pdf,.doc,.docx" style="display: none;">
              </div>
              <div id="coverLetterStatus" class="mt-2"></div>
            </div>
            
            ${hasFileQuestions ? renderFileQuestions() : ''}
          </div>
          
          <div class="step-navigation">
            <div class="nav-buttons">
              <button type="button" class="btn-step btn-previous" onclick="goToStep(2)">
                <span>‚Üê</span> Previous
              </button>
            </div>
            <div class="nav-buttons">
              <button type="submit" class="btn-step btn-next" id="documentsNextBtn">
                Next Step <span>‚Üí</span>
              </button>
            </div>
          </div>
        </form>
      `;
    }

    // Step 4: Review
    function renderReviewStep() {
      return `
        <div class="step-form">
          <div class="step-header">
            <h2 class="step-title">Review Your Application</h2>
            <p class="step-description">Please review your information before submitting your application.</p>
          </div>
          
          <div class="form-content">
            ${renderReviewSections()}
          </div>
          
          <div class="step-navigation">
            <div class="nav-buttons">
              <button type="button" class="btn-step btn-previous" onclick="goToStep(3)">
                <span>‚Üê</span> Previous
              </button>
            </div>
            <div class="nav-buttons">
              <button type="button" class="btn-step btn-submit" onclick="submitApplication()">
                Submit Application <span>üöÄ</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Helper functions for multi-step form
    function generateYearOptions() {
      const currentYear = new Date().getFullYear();
      const years = [];
      for (let year = currentYear; year <= currentYear + 6; year++) {
        years.push(`<option value="${year}">${year}</option>`);
      }
      return years.join('');
    }

    function renderQuestion(question, index) {
      if (question.type === 'file') {
        return ''; // File questions handled in documents step
      }
      
      const inputId = `question_${index}`;
      const isRequired = question.required ? ' <span class="required">*</span>' : '';
      
      return `
        <div class="input-group">
          <label class="input-label">${question.text}${isRequired}</label>
          ${question.type === 'textarea' ? 
            `<textarea class="textarea-field" name="${inputId}" id="${inputId}" rows="4" ${question.required ? 'required' : ''}></textarea>` :
            `<input type="text" class="input-field" name="${inputId}" id="${inputId}" ${question.required ? 'required' : ''}>`
          }
        </div>
      `;
    }

    function renderFileQuestions() {
      const fileQuestions = currentOpportunity.questions?.filter(q => q.type === 'file') || [];
      
      return fileQuestions.map((question, index) => {
        const fileId = `fileQuestion_${index}`;
        return `
          <div class="input-group">
            <label class="input-label">${question.text}${question.required ? ' <span class="required">*</span>' : ''}</label>
            <div class="file-upload-area" onclick="document.getElementById('${fileId}').click()">
              <div class="file-upload-icon">üìé</div>
              <div class="file-upload-text">Click to upload file</div>
              <div class="file-upload-help">PDF, DOC, DOCX, TXT (max 10MB)</div>
              <input type="file" id="${fileId}" accept=".pdf,.doc,.docx,.txt" style="display: none;">
            </div>
            <div id="${fileId}Status" class="mt-2"></div>
          </div>
        `;
      }).join('');
    }

    function renderReviewSections() {
      return `
        <!-- Personal Information Review -->
        <div class="review-section">
          <h3 class="section-title">Personal Information</h3>
          <div class="review-item">
            <span class="review-label">Name:</span>
            <span class="review-value">${applicationData.personalInfo.firstName || ''} ${applicationData.personalInfo.lastName || ''}</span>
            <button type="button" class="edit-button" onclick="goToStep(1)">Edit</button>
          </div>
          <div class="review-item">
            <span class="review-label">Email:</span>
            <span class="review-value">${applicationData.personalInfo.email || ''}</span>
            <button type="button" class="edit-button" onclick="goToStep(1)">Edit</button>
          </div>
          <div class="review-item">
            <span class="review-label">University:</span>
            <span class="review-value">${applicationData.personalInfo.university || ''}</span>
            <button type="button" class="edit-button" onclick="goToStep(1)">Edit</button>
          </div>
          <div class="review-item">
            <span class="review-label">Major:</span>
            <span class="review-value">${applicationData.personalInfo.major || ''}</span>
            <button type="button" class="edit-button" onclick="goToStep(1)">Edit</button>
          </div>
        </div>

        <!-- Questions Review -->
        ${Object.keys(applicationData.questions).length > 0 ? `
          <div class="review-section">
            <h3 class="section-title">Questions</h3>
            ${Object.entries(applicationData.questions).map(([key, value]) => `
              <div class="review-item">
                <span class="review-label">Question:</span>
                <span class="review-value">${value}</span>
                <button type="button" class="edit-button" onclick="goToStep(2)">Edit</button>
              </div>
            `).join('')}
          </div>
        ` : ''}

        <!-- Documents Review -->
        <div class="review-section">
          <h3 class="section-title">Documents</h3>
          ${Object.keys(applicationData.files).length > 0 ? 
            Object.entries(applicationData.files).map(([key, file]) => `
              <div class="review-item">
                <span class="review-label">${key}:</span>
                <span class="review-value">${file.name}</span>
                <button type="button" class="edit-button" onclick="goToStep(3)">Edit</button>
              </div>
            `).join('') : 
            '<div class="review-item"><span class="review-value text-muted">No documents uploaded yet</span></div>'
          }
        </div>
      `;
    }

    // Step navigation and progress functions
    function updateProgressBar() {
      const progressFill = document.getElementById('progressFill');
      if (progressFill) {
        const percentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
        progressFill.style.width = `${percentage}%`;
      }
      
      // Update step circles
      steps.forEach(step => {
        const circle = document.getElementById(`step${step.id}Circle`);
        if (circle) {
          circle.className = `step-circle ${getStepStatus(step.id)}`;
          circle.innerHTML = step.id <= currentStep ? (step.id < currentStep ? '‚úì' : step.icon) : step.id;
        }
      });
    }

    function goToStep(stepNumber) {
      if (stepNumber >= 1 && stepNumber <= totalSteps) {
        currentStep = stepNumber;
        document.getElementById('stepContent').innerHTML = renderStepContent(currentStep);
        updateProgressBar();
        setupStepEventListeners();
        populateFormData();
      }
    }

    function setupStepEventListeners() {
      // Personal Info Form
      const personalInfoForm = document.getElementById('personalInfoForm');
      if (personalInfoForm) {
        personalInfoForm.addEventListener('submit', handlePersonalInfoSubmit);
      }

      // Questions Form
      const questionsForm = document.getElementById('questionsForm');
      if (questionsForm) {
        questionsForm.addEventListener('submit', handleQuestionsSubmit);
      }

      // Documents Form
      const documentsForm = document.getElementById('documentsForm');
      if (documentsForm) {
        documentsForm.addEventListener('submit', handleDocumentsSubmit);
        setupFileUploads();
      }
    }

    function setupFileUploads() {
      // Resume upload
      const resumeFile = document.getElementById('resumeFile');
      if (resumeFile) {
        resumeFile.addEventListener('change', (e) => handleFileUpload(e, 'resume'));
      }

      // Cover letter upload
      const coverLetterFile = document.getElementById('coverLetterFile');
      if (coverLetterFile) {
        coverLetterFile.addEventListener('change', (e) => handleFileUpload(e, 'coverLetter'));
      }

      // Additional file questions
      const fileQuestions = currentOpportunity.questions?.filter(q => q.type === 'file') || [];
      fileQuestions.forEach((question, index) => {
        const fileInput = document.getElementById(`fileQuestion_${index}`);
        if (fileInput) {
          fileInput.addEventListener('change', (e) => handleFileUpload(e, `fileQuestion_${index}`));
        }
      });
    }

    // Step form handlers
    function handlePersonalInfoSubmit(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const personalInfo = {
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        university: formData.get('university'),
        major: formData.get('major'),
        graduationYear: formData.get('graduationYear'),
        gpa: formData.get('gpa')
      };

      // Validate required fields
      const requiredFields = ['firstName', 'lastName', 'email', 'university', 'major', 'graduationYear'];
      for (const field of requiredFields) {
        if (!personalInfo[field] || personalInfo[field].trim() === '') {
          showToast(`Please fill in your ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'error');
          return;
        }
      }

      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(personalInfo.email)) {
        showToast('Please enter a valid email address', 'error');
        return;
      }

      applicationData.personalInfo = personalInfo;
      goToStep(2);
    }

    function handleQuestionsSubmit(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const questions = currentOpportunity.questions || [];
      const answers = {};

      // Process text questions
      questions.forEach((question, index) => {
        if (question.type !== 'file') {
          const value = formData.get(`question_${index}`);
          if (question.required && (!value || value.trim() === '')) {
            showToast(`Please answer: ${question.text}`, 'error');
            return false;
          }
          if (value) {
            answers[`question_${index}`] = value;
          }
        }
      });

      applicationData.questions = answers;
      goToStep(3);
    }

    function handleDocumentsSubmit(event) {
      event.preventDefault();
      
      // Check if resume is uploaded (required)
      if (!applicationData.files.resume) {
        showToast('Please upload your resume to continue', 'error');
        return;
      }

      goToStep(4);
    }

    // File upload handler
    async function handleFileUpload(event, fileType) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file size (10MB limit)
      if (file.size > 10 * 1024 * 1024) {
        showToast('File size must be less than 10MB', 'error');
        event.target.value = '';
        return;
      }

      // Validate file type
      const allowedTypes = ['.pdf', '.doc', '.docx', '.txt'];
      const fileExt = '.' + file.name.split('.').pop().toLowerCase();
      if (!allowedTypes.includes(fileExt)) {
        showToast('Please select a valid file type (PDF, DOC, DOCX, TXT)', 'error');
        event.target.value = '';
        return;
      }

      try {
        const statusDiv = document.getElementById(`${fileType}Status`);
        
        // Show uploading state
        if (statusDiv) {
          statusDiv.innerHTML = `
            <div class="file-uploading">
              <div class="upload-spinner"></div>
              <span>Uploading ${file.name}...</span>
            </div>
          `;
        }

        // Simulate file upload (in real implementation, upload to storage)
        await new Promise(resolve => setTimeout(resolve, 1500));

        // Store file info
        applicationData.files[fileType] = {
          name: file.name,
          size: file.size,
          type: file.type,
          file: file
        };
        
        // Show success state
        if (statusDiv) {
          statusDiv.innerHTML = `
            <div class="file-uploaded">
              <span class="upload-success">‚úì ${file.name} uploaded successfully</span>
            </div>
          `;
        }

        showToast(`${file.name} uploaded successfully`, 'success');

      } catch (error) {
        console.error('File upload error:', error);
        showToast('Upload failed. Please try again.', 'error');
        event.target.value = '';
        
        const statusDiv = document.getElementById(`${fileType}Status`);
        if (statusDiv) {
          statusDiv.innerHTML = '';
        }
      }
    }

    // Populate form data when returning to previous steps
    function populateFormData() {
      if (currentStep === 1 && applicationData.personalInfo) {
        Object.entries(applicationData.personalInfo).forEach(([key, value]) => {
          const input = document.getElementById(key);
          if (input && value) {
            input.value = value;
          }
        });
      } else if (currentStep === 2 && applicationData.questions) {
        Object.entries(applicationData.questions).forEach(([key, value]) => {
          const input = document.getElementById(key);
          if (input && value) {
            input.value = value;
          }
        });
      }
    }

    // Final application submission
    async function submitApplication() {
      try {
        const session = await getSession();
        const user = session?.user;
        if (!user) {
          showToast('Authentication error. Please sign in again.', 'error');
          return;
        }

        // Combine all application data
        const fullApplication = {
          user_id: user.id,
          opportunity_id: opportunityId,
          personal_info: applicationData.personalInfo,
          answers: applicationData.questions,
          files: applicationData.files,
          status: 'submitted',
          created_at: new Date().toISOString()
        };

        console.log('Submitting application:', fullApplication);

        // Show loading state
        const submitBtn = document.querySelector('.btn-submit');
        if (submitBtn) {
          submitBtn.innerHTML = 'Submitting... <div class="upload-spinner"></div>';
          submitBtn.disabled = true;
        }

        // Simulate application submission (replace with real Supabase call)
        await new Promise(resolve => setTimeout(resolve, 2000));

        showSuccess(currentOpportunity);

      } catch (error) {
        console.error('Application submission error:', error);
        showToast('Failed to submit application. Please try again.', 'error');
      }
    }

    // Show already applied state
    function showAlreadyApplied(opportunity) {
      const container = document.getElementById('applicationContainer');
      container.innerHTML = `
        <div class="success-state">
          <div class="success-icon">‚úÖ</div>
          <h2 class="success-title">Already Applied</h2>
          <div class="success-description">
            You have already submitted an application for <strong>${opportunity.title}</strong> at <strong>${opportunity.company}</strong>.
          </div>
          <div class="actions-row">
            <a href="opportunity.html?id=${opportunity.id}" class="btn-secondary">
              View Details
            </a>
            <a href="applications.html" class="btn-primary">
              View My Applications
            </a>
          </div>
        </div>
      `;
    }

    // Show success state
    function showSuccess(opportunity) {
      const container = document.getElementById('applicationContainer');
      container.innerHTML = `
        <div class="success-state">
          <div class="success-icon">üéâ</div>
          <h2 class="success-title">Application Submitted!</h2>
          <div class="success-description">
            Your application for <strong>${opportunity.title}</strong> at <strong>${opportunity.company}</strong> has been successfully submitted. 
            You'll hear back from them soon!
          </div>
          <div class="actions-row">
            <a href="opportunities.html" class="btn-secondary">
              Browse More Opportunities
            </a>
            <a href="applications.html" class="btn-primary">
              View My Applications
            </a>
          </div>
        </div>
      `;
    }

    // Show error message
    function showError(message) {
      const container = document.getElementById('applicationContainer');
      container.innerHTML = `
        <div class="error-state">
          <div class="empty-state-icon">‚ö†Ô∏è</div>
          <h3 style="color: var(--error);">Error</h3>
          <p>${message}</p>
          <div class="mt-4">
            <a href="opportunities.html" class="btn-primary">
              Back to Opportunities
            </a>
          </div>
        </div>
      `;
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApplicationPage);
  </script>
</body>
</html>
